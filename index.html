<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>在庫管理アプリ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: "Inter","Noto Sans JP",sans-serif; }
    .view { display:none; animation: fadeIn .25s ease-in-out; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }
    @keyframes shake {
      10%,90%{transform:translate3d(-1px,0,0)}
      20%,80%{transform:translate3d(2px,0,0)}
      30%,50%,70%{transform:translate3d(-4px,0,0)}
      40%,60%{transform:translate3d(4px,0,0)}
    }
    .shake-error{animation:shake .82s cubic-bezier(.36,.07,.19,.97) both}
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }
    /* inline edit */
    .item-card .display-field{display:block}
    .item-card .edit-field{display:none}
    .item-card.is-editing .display-field{display:none}
    .item-card.is-editing .edit-field{display:block}
    /* Modal z-index */
    #order-preview-modal{z-index:50}
    #cancel-preview-modal{z-index:50}
    #loading-overlay{z-index:70}
    #alert-modal,#confirm-modal{z-index:80}
  </style>
</head>
<body class="bg-gray-100">
  <div id="app" class="max-w-md mx-auto bg-white min-h-screen shadow-lg">
    <header id="app-header" class="bg-blue-600 text-white p-4 flex justify-between items-center hidden">
      <div class="flex items-center space-x-4">
        <button id="main-menu-button" class="hidden flex items-center space-x-2 p-2 -ml-2 rounded-md hover:bg-blue-700 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"/></svg>
          <span class="text-lg font-bold">ホーム</span>
        </button>
      </div>
      <div class="text-right">
        <p id="user-name" class="text-sm"></p>
        <button id="logout-button" class="text-xs text-blue-200 hover:underline">ログアウト</button>
      </div>
    </header>

    <main class="p-4 md:p-6">
      <!-- Login -->
      <div id="view-login" class="view">
        <h2 class="text-2xl font-bold text-center mb-6 text-gray-700">在庫管理</h2>
        <div class="space-y-6">
          <div class="p-4 border rounded-lg">
            <h3 class="font-bold mb-2">管理者 / 使用者の方</h3>
            <p class="text-sm text-gray-600 mb-4">5桁のユーザー番号を入力してください</p>
            <input type="number" id="login-id-input" inputmode="numeric" pattern="[0-9]*" class="w-full p-4 border-2 border-gray-300 rounded-lg text-center text-4xl tracking-[.5em] focus:border-blue-500 focus:ring-blue-500" maxlength="5" />
          </div>
          <div class="p-4 border rounded-lg">
            <button id="other-staff-login-button" class="w-full bg-gray-500 text-white p-3 rounded-md hover:bg-gray-600 transition-colors">その他の方はこちら</button>
          </div>
        </div>
      </div>

      <!-- Home (authorized) -->
      <div id="view-home-user" class="view">
        <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">メインメニュー</h2>
        <div class="grid grid-cols-2 gap-4">
          <button id="item-list-button" class="col-span-2 bg-indigo-500 hover:bg-indigo-600 text-white p-6 rounded-lg text-lg font-bold">物品一覧</button>
          <button id="inventory-count-button" class="col-span-2 bg-cyan-500 hover:bg-cyan-600 text-white p-6 rounded-lg text-lg font-bold">棚卸し作業</button>
          <button id="new-item-button" class="col-span-2 bg-blue-500 hover:bg-blue-600 text-white p-6 rounded-lg text-lg font-bold">新規物品登録</button>
          <button id="order-history-button" class="col-span-2 bg-gray-500 hover:bg-gray-600 text-white p-6 rounded-lg text-lg font-bold">発注履歴</button>
        </div>
      </div>

      <!-- その他ログイン: 部署選択 -->
      <div id="view-home-other-1" class="view">
        <h3 class="font-bold text-lg mb-4">部署/職種を選択してください</h3>
        <div id="department-list" class="flex flex-wrap gap-3 justify-center">
          <p class="text-gray-500">部署を読み込み中...</p>
        </div>
        <button class="back-button mt-6 w-full text-center text-gray-600" data-target="view-login">戻る</button>
      </div>

      <!-- その他ログイン: PHS -->
      <div id="view-home-other-2" class="view">
        <h3 class="font-bold text-lg mb-4">PHS番号を入力してください</h3>
        <input type="number" id="phs-input" placeholder="PHS番号" class="w-full p-3 border rounded-md mb-4 focus:ring-2 focus:ring-blue-500" />
        <button id="phs-submit-button" class="w-full bg-blue-500 text-white p-3 rounded-md hover:bg-blue-600">次へ</button>
        <button class="back-button mt-4 w-full text-center text-gray-600" data-target="view-home-other-1">戻る</button>
      </div>

      <!-- その他ログイン: メニュー（スキャン機能なし） -->
      <div id="view-home-other-menu" class="view">
        <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">メインメニュー</h2>
        <div class="p-4 border rounded-lg bg-yellow-50 text-yellow-900">
          このアカウントではスキャンによる入出庫は無効です。必要な場合は管理者にご相談ください。
        </div>
        <button class="back-button mt-6 w-full text-center text-gray-600" data-target="view-login">ログイン画面に戻る</button>
      </div>

      <!-- 数量入力（物品一覧→入出庫） -->
      <div id="view-quantity" class="view">
        <h2 id="quantity-title" class="text-xl font-bold text-center mb-4"></h2>
        <p id="final-code-display" class="text-center p-2 bg-gray-100 rounded-md mb-2 break-all"></p>
        <p id="item-name-display-quantity" class="text-center text-lg font-bold mb-4 text-gray-800 h-7"></p>
        <label for="quantity-input" class="font-bold">数量:</label>
        <input type="text" id="quantity-input" class="w-full p-4 border-2 rounded-lg text-3xl text-center mt-2 select-none" inputmode="numeric" />
        <div class="mt-4 flex justify-end space-x-2">
          <button id="submit-stock-update" class="bg-blue-500 text-white px-6 py-2 rounded-lg text-lg font-bold hover:bg-blue-600">登録</button>
          <button class="back-button bg-gray-200 text-gray-700 px-6 py-2 rounded-lg">戻る</button>
        </div>
      </div>

      <!-- 新規物品登録（手入力のみ） -->
      <div id="view-new-item" class="view">
        <h2 class="text-xl font-bold mb-4">新規物品登録</h2>
        <div class="space-y-3">
          <input type="text" id="new-qr-id" placeholder="社内QRコードID (任意)" class="w-full p-3 border rounded-md" />
          <input type="text" id="new-barcode" placeholder="製品バーコード *" class="w-full p-3 border rounded-md" />
          <input type="text" id="new-item-name" placeholder="物品名 *" class="w-full p-3 border rounded-md" />
          <input type="text" id="new-model" placeholder="型番/規格" class="w-full p-3 border rounded-md" />
          <input type="number" id="new-stock" placeholder="初期在庫数 *" class="w-full p-3 border rounded-md" />
          <input type="number" id="new-reorder-point" placeholder="発注点 *" class="w-full p-3 border rounded-md" />
          <input type="number" id="new-price" placeholder="単価（円） *" class="w-full p-3 border rounded-md" />
          <input type="email" id="new-supplier-email" list="supplier-email-list" placeholder="発注先メールアドレス *" class="w-full p-3 border rounded-md" />
          <datalist id="supplier-email-list"></datalist>
        </div>
        <div class="mt-4 flex justify-end space-x-2">
          <button id="submit-new-item" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">登録する</button>
          <button class="back-button bg-gray-200 text-gray-700 px-6 py-2 rounded-lg">戻る</button>
        </div>
      </div>

      <!-- 発注履歴 -->
      <div id="view-order-history" class="view">
        <h2 class="text-xl font-bold mb-4">発注履歴</h2>
        <div id="order-history-list" class="space-y-3"></div>
        <button class="back-button mt-4 w-full text-center text-gray-600">戻る</button>
      </div>

      <!-- 完了画面 -->
      <div id="view-action-complete" class="view text-center py-12">
        <svg class="mx-auto h-16 w-16 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <h2 id="complete-message" class="mt-4 text-2xl font-bold text-gray-800"></h2>
        <p id="complete-sub-message" class="text-gray-600 mt-2"></p>
      </div>

      <!-- 物品一覧 -->
      <div id="view-item-list" class="view">
        <h2 class="text-xl font-bold mb-4 text-center">物品一覧</h2>
        <div class="mb-4 space-y-2">
          <input type="text" id="item-search-input" class="w-full p-2 border rounded-md" placeholder="物品名で検索..." />
          <div class="flex items-center space-x-4">
            <label class="flex items-center"><input type="checkbox" id="filter-reorder-needed" class="mr-2" />要発注のみ</label>
            <label class="flex items-center"><input type="checkbox" id="filter-on-order" class="mr-2" />発注中のみ</label>
          </div>
        </div>
        <div id="item-list-container" class="space-y-3"></div>
        <button class="back-button mt-6 w-full text-center text-gray-600">戻る</button>
      </div>

      <!-- 棚卸し -->
      <div id="view-inventory-count" class="view">
        <h2 class="text-xl font-bold text-center mb-2">棚卸し作業</h2>
        <p id="inventory-count-progress" class="text-center text-sm text-gray-500 mb-4"></p>

        <div class="p-4 border rounded-lg bg-gray-50">
          <h3 id="inventory-item-name" class="text-lg font-bold text-gray-800"></h3>
          <p class="text-sm text-gray-600">用途: <span id="inventory-usefor" class="font-medium text-gray-700"></span></p>
          <img id="inventory-image" alt="物品画像" class="mt-2 rounded-md w-full hidden" loading="lazy" />
          <p class="text-sm text-gray-600 mt-2">帳簿上の在庫数: <span id="inventory-expected-stock" class="font-bold text-blue-600"></span></p>
        </div>

        <div class="mt-4">
          <label for="inventory-actual-stock" class="block text-lg font-medium text-gray-700">実在庫数:</label>
          <input type="text" id="inventory-actual-stock" class="w-full p-4 border-2 rounded-lg text-4xl text-center mt-2 select-none" inputmode="numeric" />
        </div>

        <div class="mt-4 flex items-center space-x-2">
          <button id="inventory-confirm-button" class="bg-green-600 text-white px-6 py-2 rounded-md font-bold">確定</button>
          <button id="inventory-back-button" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-md">戻る</button>
        </div>
      </div>
    </main>
  </div>

  <!-- Hidden file input for photos -->
  <input id="photo-input" type="file" accept="image/*" capture="environment" hidden>

  <!-- Loading -->
  <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div>
  </div>

  <!-- Alert -->
  <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-sm text-center">
      <p id="alert-message" class="mb-4 text-gray-700"></p>
      <button id="alert-ok-button" class="bg-blue-500 text-white px-8 py-2 rounded-md hover:bg-blue-600">OK</button>
    </div>
  </div>

  <!-- Confirm -->
  <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-sm text-center">
      <p id="confirm-message" class="mb-6 text-gray-700"></p>
      <div class="flex justify-center space-x-4">
        <button id="confirm-cancel-button" class="bg-gray-300 text-gray-800 px-8 py-2 rounded-md hover:bg-gray-400">いいえ</button>
        <button id="confirm-ok-button" class="bg-blue-500 text-white px-8 py-2 rounded-md hover:bg-blue-600">はい</button>
      </div>
    </div>
  </div>

  <!-- Order preview -->
  <div id="order-preview-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-md">
      <h3 class="text-lg font-bold mb-4">発注メールの作成</h3>

      <div id="outstanding-order-warning" class="hidden mb-4 p-3 bg-red-100 border-l-4 border-red-500 text-red-800">
        <p class="font-bold">注意：未納品あり</p>
        <p id="outstanding-order-message"></p>
      </div>

      <div class="space-y-3 text-sm text-gray-700">
        <div>
          <label class="font-semibold">宛先:</label>
          <input type="email" id="preview-to-input" class="w-full mt-1 p-2 border rounded-md bg-gray-50" />
        </div>
        <div>
          <label class="font-semibold">件名:</label>
          <input type="text" id="preview-subject-input" class="w-full mt-1 p-2 border rounded-md bg-gray-50" />
        </div>
        <div>
          <label class="font-semibold">本文:</label>
          <textarea id="preview-body-input" class="w-full mt-1 p-2 border rounded-md bg-gray-50 h-48 text-sm"></textarea>
        </div>
      </div>

      <div class="flex justify-end space-x-3 mt-6">
        <button id="order-discard-button" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-md hover:bg-gray-400">破棄</button>
        <button id="order-send-button" class="bg-red-500 text-white px-6 py-2 rounded-md hover:bg-red-600">送信</button>
      </div>
    </div>
  </div>

  <!-- Cancel preview -->
  <div id="cancel-preview-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-md">
      <h3 class="text-lg font-bold mb-4">キャンセルメールの作成</h3>
      <div class="space-y-3 text-sm text-gray-700">
        <div>
          <label class="font-semibold">宛先:</label>
          <input type="email" id="cancel-to-input" class="w-full mt-1 p-2 border rounded-md bg-gray-50" />
        </div>
        <div>
          <label class="font-semibold">件名:</label>
          <input type="text" id="cancel-subject-input" class="w-full mt-1 p-2 border rounded-md bg-gray-50" />
        </div>
        <div>
          <label class="font-semibold">本文:</label>
          <textarea id="cancel-body-input" class="w-full mt-1 p-2 border rounded-md bg-gray-50 h-48 text-sm"></textarea>
        </div>
      </div>
      <div class="flex justify-end space-x-3 mt-6">
        <button id="cancel-discard-button" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-md hover:bg-gray-400">閉じる</button>
        <button id="cancel-send-button" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">送信</button>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const APP_VERSION = "2025.10.15.1";

    // キャッシュバスター
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get("v") !== APP_VERSION) {
      const newUrl = new URL(window.location.href);
      newUrl.searchParams.set("v", APP_VERSION);
      window.location.replace(newUrl.href);
      return;
    }

    const FEATURE = { inventoryAutoNext: true };

    // ===== Config =====
    const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbweMjBLulMKzhWYDyZGUUHFs_P-_1y-OJOddJerUOYfzidhImbd8HbyvmC6J_ajzpjT/exec"; // ★差し替え必須

    // ===== State =====
    const state = {
      user: null,
      currentView: null,
      historyStack: [],
      itemList: [],
      stockUpdate: { action: null, qrId: null, itemName: null },
      otherUserInfo: { department: null, phs: null },
      orderContext: { historyId: null, mailId: null },
      cancelContext: { historyId: null, mailId: null },
      inventoryCount: { items: [], currentIndex: 0 }
    };

    // ===== DOM cache =====
    const dom = {
      views: document.querySelectorAll(".view"),
      loading: document.getElementById("loading-overlay"),
      header: document.getElementById("app-header"),
      mainMenuBtn: document.getElementById("main-menu-button"),
      userName: document.getElementById("user-name"),
      loginId: document.getElementById("login-id-input"),
      photoInput: document.getElementById("photo-input"),
      modals: {
        alert: document.getElementById("alert-modal"),
        confirm: document.getElementById("confirm-modal"),
        order: document.getElementById("order-preview-modal"),
        cancel: document.getElementById("cancel-preview-modal")
      }
    };

    // ===== Helpers =====
    const showView = (id, isBack=false) => {
      dom.views.forEach(v => v.style.display="none");
      const el = document.getElementById(id);
      if (el) {
        el.style.display = "block";
        if (!isBack && state.currentView) state.historyStack.push(state.currentView);
        state.currentView = id;
      }
      dom.header.classList.toggle("hidden", id === "view-login" || id === "view-home-other-1");
      const isMain = id === "view-home-user" || id === "view-login";
      dom.mainMenuBtn.classList.toggle("hidden", isMain);
    };
    const goBack = () => { const prev = state.historyStack.pop(); if (prev) showView(prev, true); };
    const goHome = () => { state.historyStack = []; showView("view-home-user"); };
    const toggleLoading = (on) => dom.loading.classList.toggle("hidden", !on);
    const showAlert = (msg) => {
      document.getElementById("alert-message").textContent = msg;
      dom.modals.alert.classList.remove("hidden");
    };
    document.getElementById("alert-ok-button").addEventListener("click", () => dom.modals.alert.classList.add("hidden"));

    const ensureCenteredModal = (modalEl) => {
      // 念のため中央に固定
      modalEl.classList.remove("hidden");
    };

    // ===== API =====
    const callGasApi = async (action, payload={}) => {
      toggleLoading(true);
      try {
        const req = { action, payload };
        const noAuth = ["login","get_departments","get_supplier_emails","get_item_name","get_item_details"];
        if (!noAuth.includes(action)) {
          if (!state.user) throw new Error("認証情報がありません。再ログインしてください。");
          req.payload.auth = { email: state.user.email };
        }
        const res = await fetch(GAS_WEB_APP_URL, {
          method: "POST",
          mode: "cors",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify(req)
        });
        const json = await res.json();
        if (json.status === "error") throw new Error(json.message || "不明なエラー");
        return json;
      } catch (e) {
        showAlert(`エラー: ${e.message}`);
        return null;
      } finally {
        toggleLoading(false);
      }
    };

    // ===== Auth =====
    const handleLogin = async (payload) => {
      const result = await callGasApi("login", payload);
      if (result && result.status === "success") {
        state.user = result.data;
        dom.userName.textContent = state.user.name || "";
        const home = ["管理者","使用者"].includes(state.user.role) ? "view-home-user" : "view-home-other-1";
        showView(home);
        if (home === "view-home-other-1") loadDepartments();
      } else {
        state.user = null;
        dom.loginId.classList.add("shake-error");
        if (navigator.vibrate) navigator.vibrate([100,50,100]);
        setTimeout(() => {
          dom.loginId.classList.remove("shake-error");
          dom.loginId.value = "";
        }, 820);
      }
    };
    const handleLogout = () => {
      state.user = null; state.historyStack = []; dom.loginId.value = "";
      loadDepartments(); showView("view-login");
    };

    // ===== Masters =====
    const loadDepartments = async () => {
      const listEl = document.getElementById("department-list");
      const result = await callGasApi("get_departments");
      if (result && result.status === "success" && result.data.length) {
        listEl.innerHTML = "";
        result.data.forEach(name => {
          const btn = document.createElement("button");
          btn.textContent = name;
          btn.className = "bg-white border border-gray-300 px-4 py-2 rounded-full hover:bg-gray-100 shadow-sm";
          btn.addEventListener("click", () => { state.otherUserInfo.department = name; showView("view-home-other-2"); });
          listEl.appendChild(btn);
        });
      } else {
        listEl.innerHTML = `<p class="text-red-500">${result ? "部署未登録" : "部署読込失敗"}</p>`;
      }
    };
    const loadSupplierEmails = async () => {
      const result = await callGasApi("get_supplier_emails");
      const dl = document.getElementById("supplier-email-list");
      dl.innerHTML = "";
      if (result && result.status === "success") {
        result.data.forEach(email => { const opt = document.createElement("option"); opt.value = email; dl.appendChild(opt); });
      }
    };

    // ===== Item list =====
    const handleShowItemList = async () => {
      const result = await callGasApi("get_item_list");
      if (result && result.data) {
        state.itemList = result.data;
        renderItemList();
        showView("view-item-list");
      }
    };
    const renderItemList = () => {
      const container = document.getElementById("item-list-container");
      const q = (document.getElementById("item-search-input").value || "").toLowerCase();
      const onlyReorder = document.getElementById("filter-reorder-needed").checked;
      const onlyOnOrder = document.getElementById("filter-on-order").checked;

      let items = [...state.itemList];
      if (q) items = items.filter(i => (i.itemName || "").toLowerCase().includes(q));
      if (onlyReorder) items = items.filter(i => Number(i.stock) < Number(i.reorderPoint));
      if (onlyOnOrder) items = items.filter(i => Number(i.orderedQuantity) > 0);

      if (!items.length) {
        container.innerHTML = `<p class="text-center text-gray-500">該当する物品はありません。</p>`;
        return;
      }

      container.innerHTML = items.map(item => `
        <div class="item-card p-3 border rounded-lg shadow-sm"
             data-barcode="${item.barcode || ""}"
             data-qr-id="${item.qrId || ""}"
             data-code="${item.barcode || item.qrId || ""}"
             data-item-name="${item.itemName || ""}">
          <div class="flex items-start justify-between">
            <div class="min-w-0">
              <h3 class="font-bold text-base leading-tight truncate">${item.itemName || ""}</h3>
              <p class="text-xs text-gray-600 mt-1">用途: ${item.useFor || "—"}</p>
            </div>
            ${item.imageUrl ? `<img src="${item.imageUrl}" alt="" class="w-16 h-16 object-cover rounded ml-3">` : ""}
          </div>

          <div class="display-field mt-2 text-sm space-y-2">
            <div class="flex justify-between items-center">
              <div class="flex items-center space-x-4">
                <div><span class="font-semibold text-gray-600">在庫:</span> <span class="font-bold text-lg">${item.stock ?? ""}</span></div>
                <div><span class="font-semibold text-gray-600">発注点:</span> <span class="text-red-500 font-bold text-lg">${item.reorderPoint ?? ""}</span></div>
              </div>
              <div><span class="font-semibold text-gray-600">単価:</span> ¥${Number(item.price || 0).toLocaleString()}</div>
            </div>
            <div class="flex justify-between items-center text-xs text-gray-500 pt-1 border-t">
              <div><span class="font-semibold">発注上限:</span> ${item.parLevel || "未設定"}</div>
              <div><span class="font-semibold">発注中:</span> ${item.orderedQuantity || 0}</div>
            </div>
          </div>

          <div class="mt-3 flex flex-wrap justify-end gap-2">
            <button class="photo-button bg-purple-500 text-white px-3 py-1 rounded-md text-sm">写真</button>
            <button class="inflow-button bg-green-500 text-white px-3 py-1 rounded-md text-sm">入庫</button>
            <button class="outflow-button bg-yellow-500 text-white px-3 py-1 rounded-md text-sm">出庫</button>
            <button class="edit-button bg-blue-500 text-white px-3 py-1 rounded-md text-sm">変更</button>
            <button class="save-button hidden bg-green-600 text-white px-3 py-1 rounded-md text-sm">保存</button>
            <button class="cancel-button hidden bg-gray-500 text-white px-3 py-1 rounded-md text-sm">中止</button>
          </div>
        </div>
      `).join("");
    };

    const handleItemListClick = (e) => {
      const card = e.target.closest(".item-card");
      if (!card) return;

      const code = card.dataset.code;
      const itemName = card.dataset.itemName || "";

      if (e.target.classList.contains("photo-button")) {
        pickPhotoAndUpload({ code, itemName });
      } else if (e.target.classList.contains("inflow-button") || e.target.classList.contains("outflow-button")) {
        const action = e.target.classList.contains("inflow-button") ? "入庫" : "出庫";
        state.stockUpdate = { action, qrId: code, itemName };
        document.getElementById("final-code-display").textContent = code || "";
        document.getElementById("item-name-display-quantity").textContent = itemName || "";
        document.getElementById("quantity-title").textContent = action;
        const qEl = document.getElementById("quantity-input");
        qEl.value = "1";
        showView("view-quantity");
        attachSpinHandlers(qEl, 1, 9999);
      } else if (e.target.classList.contains("edit-button")) {
        card.classList.add("is-editing");
        e.target.classList.add("hidden");
        card.querySelector(".save-button").classList.remove("hidden");
        card.querySelector(".cancel-button").classList.remove("hidden");
      } else if (e.target.classList.contains("cancel-button")) {
        card.classList.remove("is-editing");
        card.querySelector(".save-button").classList.add("hidden");
        card.querySelector(".edit-button").classList.remove("hidden");
        renderItemList();
      } else if (e.target.classList.contains("save-button")) {
        const payload = {
          barcode: card.dataset.barcode,
          itemName: card.querySelector(".edit-item-name")?.value || itemName,
          stock: card.querySelector(".edit-stock")?.value || "",
          reorderPoint: card.querySelector(".edit-reorder-point")?.value || "",
          price: card.querySelector(".edit-price")?.value || "",
          parLevel: card.querySelector(".edit-par-level")?.value || "",
          orderedQuantity: card.querySelector(".edit-ordered-quantity")?.value || ""
        };
        callGasApi("update_item", payload).then(r => {
          if (r && r.status === "success") { showAlert("更新しました。"); handleShowItemList(); }
        });
      }
    };

    // ===== Photo upload =====
    function pickPhotoAndUpload(item) {
      dom.photoInput.onchange = async () => {
        const file = dom.photoInput.files && dom.photoInput.files[0];
        if (!file) return;
        try {
          const dataUrl = await fileToJpegDataURL(file);
          const fileName = `${(item.itemName||'photo').replace(/[^\w\-ぁ-んァ-ヶ一-龠]/g,'_')}_${Date.now()}.jpg`;
          const payload = { code: item.code || item.itemName, dataUrl, fileName };
          const res = await callGasApi('upload_item_image', payload);
          if (res && res.status === 'success') {
            showAlert('画像を登録しました。');
            handleShowItemList();
          }
        } catch (e) {
          showAlert('画像登録に失敗しました: ' + e.message);
        } finally {
          dom.photoInput.value = '';
        }
      };
      dom.photoInput.click();
    }

    async function fileToJpegDataURL(file) {
      const baseDataUrl = await new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
      const img = await new Promise((resolve, reject) => {
        const i = new Image();
        i.onload = () => resolve(i);
        i.onerror = reject;
        i.src = baseDataUrl;
      });
      const MAX = 1280;
      const scale = Math.min(1, MAX / Math.max(img.width, img.height));
      const canvas = document.createElement('canvas');
      canvas.width = Math.round(img.width * scale);
      canvas.height = Math.round(img.height * scale);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      return canvas.toDataURL('image/jpeg', 0.85);
    }

    // ===== Spin (drum roll) handlers =====
    function attachSpinHandlers(input, min=0, max=999999) {
      let startY = null;
      let startVal = null;
      const parse = () => {
        const v = parseInt(String(input.value).replace(/[^\d-]/g,''),10);
        if (Number.isNaN(v)) return 0;
        return v;
      };
      const clamp = (n) => Math.max(min, Math.min(max, n));

      input.addEventListener('wheel', (e) => {
        e.preventDefault();
        const cur = parse();
        const next = clamp(cur + (e.deltaY > 0 ? -1 : 1));
        input.value = String(next);
      }, { passive:false });

      input.addEventListener('touchstart', (e) => {
        if (!e.touches[0]) return;
        startY = e.touches[0].clientY;
        startVal = parse();
      }, { passive:true });

      input.addEventListener('touchmove', (e) => {
        if (startY == null || startVal == null) return;
        const dy = e.touches[0].clientY - startY;
        if (Math.abs(dy) > 24) {
          const step = -Math.sign(dy); // 上スワイプで+1
          const cur = parse();
          input.value = String(clamp(cur + step));
          startY = e.touches[0].clientY;
        }
      }, { passive:true });
    }

    // ===== Stock update (in/out) =====
    const handleStockUpdate = async () => {
      const qty = parseInt(String(document.getElementById("quantity-input").value).replace(/[^\d]/g,''), 10);
      if (!qty || qty <= 0) { showAlert("正しい数量を入力してください。"); return; }
      const payload = {
        qrId: state.stockUpdate.qrId,
        type: state.stockUpdate.action,
        quantity: qty,
        department: state.otherUserInfo.department,
        phs: state.otherUserInfo.phs
      };
      const result = await callGasApi("stock_update", payload);
      if (!result) return;

      if (result.status === "success") {
        if (result.orderRequired) {
          state.orderContext.historyId = result.historyId;
          document.getElementById("preview-to-input").value = result.mailPreview.to || "";
          document.getElementById("preview-subject-input").value = result.mailPreview.subject || "";
          document.getElementById("preview-body-input").value = result.mailPreview.body || "";

          const warn = document.getElementById("outstanding-order-warning");
          if (result.outstandingOrder?.exists) {
            document.getElementById("outstanding-order-message").textContent = `現在 ${result.outstandingOrder.quantity} 個、発注済みです。`;
            warn.classList.remove("hidden");
          } else {
            warn.classList.add("hidden");
          }
          ensureCenteredModal(dom.modals.order);
        } else {
          showAlert("在庫を更新しました。");
          showView("view-item-list");
        }
      }
    };

    // ===== Inventory count =====
    const startInventoryCount = async () => {
      const result = await callGasApi("get_item_list");
      if (result && result.data) {
        state.inventoryCount.items = result.data;
        state.inventoryCount.currentIndex = 0;
        displayCurrentInventoryItem();
        showView("view-inventory-count");
      }
    };
    const displayCurrentInventoryItem = () => {
      const { items, currentIndex } = state.inventoryCount;
      if (currentIndex >= items.length) {
        document.getElementById("complete-message").textContent = "棚卸し完了";
        document.getElementById("complete-sub-message").textContent = "全ての物品の確認が終わりました。";
        showView("view-action-complete");
        setTimeout(goHome, 1000);
        return;
      }
      const item = items[currentIndex];
      document.getElementById("inventory-count-progress").textContent = `${currentIndex + 1} / ${items.length}`;
      document.getElementById("inventory-item-name").textContent = item.itemName || "";
      document.getElementById("inventory-expected-stock").textContent = item.stock ?? "";
      const useEl = document.getElementById("inventory-usefor");
      useEl.textContent = item.useFor ? item.useFor : "—";
      const imgEl = document.getElementById("inventory-image");
      if (item.imageUrl) {
        imgEl.src = item.imageUrl; imgEl.classList.remove("hidden");
      } else {
        imgEl.removeAttribute("src"); imgEl.classList.add("hidden");
      }
      const input = document.getElementById("inventory-actual-stock");
      input.value = item.stock ?? 0;
      attachSpinHandlers(input, 0, 999999);
      input.focus();
    };
    const handleInventoryConfirm = async () => {
      const { items, currentIndex } = state.inventoryCount;
      if (currentIndex >= items.length) return;
      const item = items[currentIndex];
      const actual = parseInt(String(document.getElementById("inventory-actual-stock").value).replace(/[^\d]/g,''), 10);
      if (Number.isNaN(actual) || actual < 0) { showAlert("有効な在庫数を入力してください。"); return; }
      const payload = { qrId: item.barcode || item.qrId, type: "棚卸修正", quantity: actual, isCorrection: true };
      const result = await callGasApi("stock_update", payload);
      if (!result) return;

      if (result.status === "success") {
        if (result.orderRequired) {
          state.orderContext.historyId = result.historyId;
          document.getElementById("preview-to-input").value = result.mailPreview.to || "";
          document.getElementById("preview-subject-input").value = result.mailPreview.subject || "";
          document.getElementById("preview-body-input").value = result.mailPreview.body || "";
          document.getElementById("outstanding-order-warning").classList.add("hidden");
          ensureCenteredModal(dom.modals.order);
        } else {
          if (FEATURE.inventoryAutoNext) {
            state.inventoryCount.currentIndex++;
            displayCurrentInventoryItem();
          } else {
            showAlert("棚卸しを更新しました。");
          }
        }
      }
    };

    // ===== Orders =====
    const parseQuantityFromBody = (text) => {
      const m = String(text || "").match(/数量[：:\s]*([0-9]+)/);
      return m ? parseInt(m[1],10) : null;
    };
    const handleOrderSend = async () => {
      const to = document.getElementById("preview-to-input").value.trim();
      const subject = document.getElementById("preview-subject-input").value.trim();
      const body = document.getElementById("preview-body-input").value.trim();
      if (!to || !subject || !body) { showAlert("宛先・件名・本文は必須です。"); return; }
      const qFromBody = parseQuantityFromBody(body);
      if (!qFromBody || qFromBody <= 0) { showAlert("本文の『数量』を正しい数値にしてください。"); return; }

      const payload = { to, subject, body, historyId: state.orderContext.historyId, quantity: qFromBody };
      const result = await callGasApi("send_order", payload);
      if (!result) return;

      dom.modals.order.classList.add("hidden");

      // 直後にキャンセル下書きを表示
      if (result.cancelPreview) {
        state.cancelContext.historyId = state.orderContext.historyId;
        state.cancelContext.mailId = result.mailId || null;
        document.getElementById("cancel-to-input").value = result.cancelPreview.to || "";
        document.getElementById("cancel-subject-input").value = result.cancelPreview.subject || "";
        document.getElementById("cancel-body-input").value = result.cancelPreview.body || "";
        ensureCenteredModal(dom.modals.cancel);
      }

      if (state.currentView === "view-inventory-count" && FEATURE.inventoryAutoNext) {
        state.inventoryCount.currentIndex++;
        displayCurrentInventoryItem();
      } else if (state.currentView === "view-item-list") {
        handleShowItemList();
      } else {
        goHome();
      }
    };

    // 履歴からキャンセル: まず下書きを取得してプレビュー
    const handleGetOrderHistory = async () => {
      const result = await callGasApi("get_order_history", {});
      if (!result || !result.data) return;
      const list = document.getElementById("order-history-list");
      if (!result.data.length) {
        list.innerHTML = `<p class="text-center text-gray-500">履歴はありません。</p>`;
      } else {
        list.innerHTML = result.data.map(r => `
          <div class="border rounded-md p-3">
            <div class="flex justify-between items-center">
              <div>
                <p class="font-semibold">${r.itemName || "不明な物品"}</p>
                <p class="text-xs text-gray-500">${r.orderDate} / 数量: ${r.quantity} / ステータス: ${r.status}</p>
              </div>
              ${r.status === "注文済み" ? `<button class="cancel-order-button bg-blue-500 text-white px-3 py-1 rounded text-sm" data-mail-id="${r.mailId}" data-history-id="${r.historyId}">キャンセル</button>` : ``}
            </div>
          </div>
        `).join("");
      }
      showView("view-order-history");
    };
    const handleCancelOrderFromHistory = async (mailId, historyId) => {
      const preview = await callGasApi("get_cancel_preview", { historyId });
      if (preview && preview.status === "success") {
        state.cancelContext.historyId = historyId;
        state.cancelContext.mailId = mailId || null;
        document.getElementById("cancel-to-input").value = preview.data.to || "";
        document.getElementById("cancel-subject-input").value = preview.data.subject || "";
        document.getElementById("cancel-body-input").value = preview.data.body || "";
        ensureCenteredModal(dom.modals.cancel);
      }
    };
    const handleCancelSend = async () => {
      const to = document.getElementById("cancel-to-input").value.trim();
      const subject = document.getElementById("cancel-subject-input").value.trim();
      const body = document.getElementById("cancel-body-input").value.trim();
      if (!to || !subject || !body) { showAlert("宛先・件名・本文は必須です。"); return; }
      // cancel_order は本文を再構築して送る仕様のため、このUIの本文は現状プレビュー扱い。
      const result = await callGasApi("cancel_order", { mailId: state.cancelContext.mailId, historyId: state.cancelContext.historyId });
      if (result && result.status === "success") {
        dom.modals.cancel.classList.add("hidden");
        showAlert("キャンセルメールを送信しました。");
        handleGetOrderHistory();
      }
    };

    // ===== New item =====
    const handleNewItemRegistration = async () => {
      const payload = {
        qrId: document.getElementById("new-qr-id").value.trim(),
        barcode: document.getElementById("new-barcode").value.trim(),
        itemName: document.getElementById("new-item-name").value.trim(),
        model: document.getElementById("new-model").value.trim(),
        stock: Number(document.getElementById("new-stock").value),
        reorderPoint: Number(document.getElementById("new-reorder-point").value),
        price: Number(document.getElementById("new-price").value),
        supplierEmail: document.getElementById("new-supplier-email").value.trim()
      };
      if (!payload.barcode || !payload.itemName || !payload.stock || !payload.reorderPoint || !payload.price || !payload.supplierEmail) {
        showAlert("必須項目（*）を入力してください。"); return;
      }
      const result = await callGasApi("item_register", payload);
      if (result && result.status === "success") {
        showAlert("登録しました。");
        document.querySelectorAll("#view-new-item input").forEach(i => i.value = "");
      }
    };

    // ===== Listeners =====
    const setupListeners = () => {
      // Login
      dom.loginId.addEventListener("input", () => { if (dom.loginId.value.length === 5) handleLogin({ loginId: dom.loginId.value }); });
      document.getElementById("other-staff-login-button").addEventListener("click", () => {
        state.user = { role: "その他" };
        dom.userName.textContent = "その他";
        showView("view-home-other-1");
        loadDepartments();
      });
      document.getElementById("phs-submit-button").addEventListener("click", () => {
        const phs = document.getElementById("phs-input").value;
        if (phs && phs.trim() !== "") { state.otherUserInfo.phs = phs.trim(); showView("view-home-other-menu"); }
        else { showAlert("PHS番号を入力してください。"); }
      });

      // Header
      dom.mainMenuBtn.addEventListener("click", goHome);
      document.getElementById("logout-button").addEventListener("click", handleLogout);

      // Home menu
      document.getElementById("item-list-button").addEventListener("click", handleShowItemList);
      document.getElementById("inventory-count-button").addEventListener("click", startInventoryCount);
      document.getElementById("new-item-button").addEventListener("click", () => { loadSupplierEmails(); showView("view-new-item"); });
      document.getElementById("order-history-button").addEventListener("click", handleGetOrderHistory);

      // Common back buttons
      document.querySelectorAll(".back-button").forEach(b => b.addEventListener("click", e => {
        const target = e.currentTarget.dataset.target;
        target ? showView(target) : goBack();
      }));

      // Quantity (in/out)
      document.getElementById("submit-stock-update").addEventListener("click", handleStockUpdate);

      // Item list
      document.getElementById("item-list-container").addEventListener("click", handleItemListClick);
      document.getElementById("item-search-input").addEventListener("input", renderItemList);
      document.getElementById("filter-reorder-needed").addEventListener("change", renderItemList);
      document.getElementById("filter-on-order").addEventListener("change", renderItemList);

      // Inventory
      document.getElementById("inventory-confirm-button").addEventListener("click", handleInventoryConfirm);
      document.getElementById("inventory-back-button").addEventListener("click", goBack);

      // Orders
      document.getElementById("order-send-button").addEventListener("click", handleOrderSend);
      document.getElementById("order-discard-button").addEventListener("click", () => dom.modals.order.classList.add("hidden"));

      // Cancel preview/send
      document.getElementById("order-history-list").addEventListener("click", (e) => {
        const btn = e.target.closest(".cancel-order-button");
        if (!btn) return;
        handleCancelOrderFromHistory(btn.dataset.mailId, btn.dataset.historyId);
      });
      document.getElementById("cancel-send-button").addEventListener("click", handleCancelSend);
      document.getElementById("cancel-discard-button").addEventListener("click", () => dom.modals.cancel.classList.add("hidden"));
    };

    // ===== init =====
    const init = () => { setupListeners(); showView("view-login"); };
    init();
  });
  </script>
</body>
</html>
