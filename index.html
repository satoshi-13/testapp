<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>物品管理アプリ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    :root { --brand:#2563eb; }
    body { font-family:"Inter","Noto Sans JP", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji"; background:#f6f7fb; }
    .view{ display:none; animation:fade .22s ease }
    @keyframes fade { from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none} }
    /* 正方形画像（高速） */
    .square-wrap{ position:relative; width:100%; aspect-ratio:1/1; overflow:hidden; border-radius:.75rem; background:#f2f4f7 }
    .square-wrap img{ width:100%; height:100%; object-fit:cover; display:block }
    .img-overlay{
      position:absolute; left:0; right:0; bottom:0;
      display:flex; justify-content:space-between; gap:.5rem;
      background:linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.55) 90%);
      color:#fff; padding:.6rem .7rem;
    }
    .text-truncate{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    /* ドラムロール(縦スクロール/スワイプ/ボタン/キーボード/Wheel) */
    .roller{
      min-width:68px; height:40px; border-radius:.5rem;
      background:rgba(255,255,255,.92); color:#111; display:flex; align-items:center; justify-content:center;
      border:2px solid var(--brand); font-weight:700; font-size:18px; user-select:none; touch-action:pan-y;
    }
    .roller:focus{ outline:3px solid rgba(37,99,235,.35) }
    .roller-btn{ width:34px; height:40px; display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:700; color:#1f2937 }
    .roller-group{ display:flex; align-items:center; background:rgba(255,255,255,.88); border-radius:.75rem; overflow:hidden; border:1px solid #d1d5db }
    /* Header */
    #app-header{ background:#2563eb; color:#fff }
    /* Loading / Modals */
    #loading-overlay{ z-index:70 }
    #alert-modal,#confirm-modal,#order-preview-modal{ z-index:80 }
    /* Item card */
    .item-card .display{ display:block } .item-card.edit .display{ display:none }
    .item-card .edit{ display:none } .item-card.edit .edit{ display:block }
  </style>
</head>
<body>
  <div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-lg">

    <!-- Header -->
    <header id="app-header" class="hidden p-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-lg font-bold tracking-wide">物品管理アプリ</span>
        <button id="main-menu-button" class="flex items-center gap-2 px-2 py-1 rounded-md hover:bg-blue-700 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125
                 c0 .621.504 1.125 1.125 1.125H9.75v-4.875
                 c0-.621.504-1.125 1.125-1.125h2.25
                 c.621 0 1.125.504 1.125 1.125V21h4.125
                 c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25"/>
          </svg>
          <span class="text-lg font-bold">ホーム</span>
        </button>
      </div>
      <div class="text-right">
        <p id="user-name" class="text-sm"></p>
        <button id="logout-button" class="text-xs text-blue-200 hover:underline">ログアウト</button>
      </div>
    </header>

    <main class="p-4 md:p-6">

      <!-- Login -->
      <div id="view-login" class="view">
        <h2 class="text-2xl font-bold text-center mb-6 text-gray-700">在庫管理</h2>
        <div class="space-y-6">
          <div class="p-4 border rounded-lg">
            <h3 class="font-bold mb-2">管理者 / 使用者の方</h3>
            <p class="text-sm text-gray-600 mb-3">5桁のユーザー番号を入力してください</p>
            <input type="number" id="login-id-input" inputmode="numeric" pattern="[0-9]*"
              class="w-full p-4 border-2 border-gray-300 rounded-lg text-center text-4xl tracking-[.5em]
                     focus:border-blue-500 focus:ring-blue-500" maxlength="5" />
          </div>
          <div class="p-4 border rounded-lg">
            <button id="other-staff-login-button"
              class="w-full bg-gray-500 text-white p-3 rounded-md hover:bg-gray-600">その他の方はこちら</button>
          </div>
        </div>
      </div>

      <!-- Home -->
      <div id="view-home-user" class="view">
        <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">メインメニュー</h2>
        <div class="grid grid-cols-2 gap-4">
          <button id="item-list-button" class="col-span-2 bg-indigo-500 hover:bg-indigo-600 text-white p-6 rounded-lg text-lg font-bold">物品一覧</button>
          <button id="inventory-count-button" class="col-span-2 bg-cyan-500 hover:bg-cyan-600 text-white p-6 rounded-lg text-lg font-bold">棚卸し作業</button>
          <button id="order-history-button" class="col-span-2 bg-gray-500 hover:bg-gray-600 text-white p-6 rounded-lg text-lg font-bold">発注履歴</button>
        </div>
      </div>

      <!-- 物品一覧 -->
      <div id="view-item-list" class="view">
        <h2 class="text-xl font-bold mb-4 text-center">物品一覧</h2>
        <div class="mb-4 space-y-2">
          <input type="text" id="item-search-input" class="w-full p-2 border rounded-md" placeholder="物品名で検索..." />
          <div class="flex items-center space-x-4">
            <label class="flex items-center"><input type="checkbox" id="filter-reorder-needed" class="mr-2" />要発注のみ</label>
            <label class="flex items-center"><input type="checkbox" id="filter-on-order" class="mr-2" />発注中のみ</label>
          </div>
        </div>
        <div id="item-list-container" class="space-y-3"></div>
        <button class="back-button mt-6 w-full text-center text-gray-600">戻る</button>
        <!-- hidden camera input (reuse) -->
        <input type="file" id="photo-file-input" accept="image/*" capture="environment" class="hidden" />
      </div>

      <!-- 発注履歴 -->
      <div id="view-order-history" class="view">
        <h2 class="text-xl font-bold mb-4">発注履歴</h2>
        <div id="order-history-list" class="space-y-3"></div>
        <button class="back-button mt-4 w-full text-center text-gray-600">戻る</button>
      </div>

      <!-- 棚卸し（スマホ1画面完結UI） -->
      <div id="view-inventory-count" class="view">
        <h2 class="text-xl font-bold text-center mb-2">棚卸し作業</h2>
        <p id="inventory-count-progress" class="text-center text-sm text-gray-500 mb-3"></p>

        <div class="square-wrap shadow-sm">
          <img id="inventory-image" alt="物品画像" />
          <div class="img-overlay">
            <div class="min-w-0">
              <p id="inventory-item-name" class="text-sm font-bold text-truncate"></p>
              <p id="inventory-usefor" class="text-xs text-gray-200 text-truncate"></p>
            </div>
            <div class="roller-group">
              <button id="roller-dec" class="roller-btn" aria-label="減らす">－</button>
              <div id="inventory-roller" class="roller" role="spinbutton" aria-valuemin="0" aria-valuemax="99999" aria-valuenow="0" tabindex="0">0</div>
              <button id="roller-inc" class="roller-btn" aria-label="増やす">＋</button>
            </div>
          </div>
        </div>

        <div class="mt-4 flex items-center justify-between px-1">
          <button id="inventory-back-button" class="px-5 py-2 rounded-md border text-gray-700">戻る</button>
          <button id="inventory-confirm-button" class="bg-green-600 text-white px-6 py-2 rounded-md font-bold">確定</button>
        </div>
      </div>

      <!-- 完了 -->
      <div id="view-action-complete" class="view text-center py-12">
        <svg class="mx-auto h-16 w-16 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <h2 id="complete-message" class="mt-4 text-2xl font-bold text-gray-800"></h2>
        <p id="complete-sub-message" class="text-gray-600 mt-2"></p>
      </div>
    </main>
  </div>

  <!-- Loading -->
  <div id="loading-overlay" class="fixed inset-0 bg-black/50 flex justify-center items-center hidden">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div>
  </div>

  <!-- Alert -->
  <div id="alert-modal" class="fixed inset-0 bg-black/50 flex justify-center items-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-sm text-center">
      <p id="alert-message" class="mb-4 text-gray-700"></p>
      <button id="alert-ok-button" class="bg-blue-500 text-white px-8 py-2 rounded-md hover:bg-blue-600">OK</button>
    </div>
  </div>

  <!-- Confirm -->
  <div id="confirm-modal" class="fixed inset-0 bg-black/50 flex justify-center items-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-sm text-center">
      <p id="confirm-message" class="mb-6 text-gray-700"></p>
      <div class="flex justify-center gap-4">
        <button id="confirm-cancel-button" class="bg-gray-300 text-gray-800 px-8 py-2 rounded-md hover:bg-gray-400">いいえ</button>
        <button id="confirm-ok-button" class="bg-blue-500 text-white px-8 py-2 rounded-md hover:bg-blue-600">はい</button>
      </div>
    </div>
  </div>

  <!-- Order preview -->
  <div id="order-preview-modal" class="fixed inset-0 bg-black/50 flex justify-center items-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-md">
      <h3 class="text-lg font-bold mb-4">発注メールの作成</h3>

      <div id="outstanding-order-warning" class="hidden mb-4 p-3 bg-red-100 border-l-4 border-red-500 text-red-800">
        <p class="font-bold">注意：未納品あり</p>
        <p id="outstanding-order-message"></p>
      </div>

      <div class="space-y-3 text-sm text-gray-700">
        <div>
          <label for="preview-to-input" class="font-semibold">宛先:</label>
          <input type="email" id="preview-to-input" class="w-full mt-1 p-2 border rounded-md bg-gray-50" />
        </div>
        <div>
          <label for="preview-subject-input" class="font-semibold">件名:</label>
          <input type="text" id="preview-subject-input" class="w-full mt-1 p-2 border rounded-md bg-gray-50" />
        </div>
        <div>
          <label for="preview-body-input" class="font-semibold">本文（数量を直接編集できます）:</label>
          <textarea id="preview-body-input" class="w-full mt-1 p-2 border rounded-md bg-gray-50 h-48 text-sm"></textarea>
        </div>
      </div>

      <div class="flex justify-end gap-3 mt-6">
        <button id="order-discard-button" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-md hover:bg-gray-400">破棄</button>
        <button id="order-send-button" class="bg-red-500 text-white px-6 py-2 rounded-md hover:bg-red-600 flex items-center justify-center w-28">送信</button>
      </div>
    </div>
  </div>

  <script>
  (() => {
    // ====== 設定 ======
    const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzQxU-a5lVVWm4QHcq8TvAYM03AKeHl9NlpIoPiYUpVN0DfreRZo5WbgDNbYTdNRw7S/exec"; // ←デプロイURLを入れる
    const APP_VERSION = "2025.10.15.UI-ROLLER";

    // キャッシュバスター
    const params = new URLSearchParams(location.search);
    if (params.get("v") !== APP_VERSION) {
      const u = new URL(location.href);
      u.searchParams.set("v", APP_VERSION);
      location.replace(u.href);
      return;
    }

    // ====== 状態 ======
    const state = {
      user: null,
      historyStack: [],
      currentView: null,
      itemList: [],
      orderContext: { historyId:null, unitPrice:0 },
      // 棚卸しワーク
      inventory: { items:[], idx:0, rollerValue:0 },
      // 写真アップロード一時
      photoTarget: { barcode:null }
    };

    // ====== DOM ======
    const dom = {
      views: document.querySelectorAll(".view"),
      header: document.getElementById("app-header"),
      mainMenuBtn: document.getElementById("main-menu-button"),
      userName: document.getElementById("user-name"),
      loading: document.getElementById("loading-overlay"),
      modals: {
        alert: document.getElementById("alert-modal"),
        confirm: document.getElementById("confirm-modal"),
        order: document.getElementById("order-preview-modal")
      }
    };

    // ====== 便利関数 ======
    const showView = (id, isBack=false) => {
      dom.views.forEach(v => v.style.display = "none");
      const el = document.getElementById(id);
      if (el) {
        el.style.display = "block";
        if (!isBack && state.currentView) state.historyStack.push(state.currentView);
        state.currentView = id;
      }
      // header 表示制御
      dom.header.classList.toggle("hidden", id === "view-login");
      // ホームボタン表示
      const isMain = (id === "view-home-user" || id === "view-login");
      dom.mainMenuBtn.classList.toggle("hidden", isMain);
    };
    const goBack = () => { const prev = state.historyStack.pop(); if (prev) showView(prev, true); };
    const goHome = () => { state.historyStack = []; showView("view-home-user"); };
    const toggleLoading = (on) => dom.loading.classList.toggle("hidden", !on);
    const alert = (msg) => { document.getElementById("alert-message").textContent = msg; dom.modals.alert.classList.remove("hidden"); };
    let confirmCb = null;
    const confirm = (msg, cb) => { document.getElementById("confirm-message").textContent = msg; dom.modals.confirm.classList.remove("hidden"); confirmCb = cb; };
    const hideModals = () => { Object.values(dom.modals).forEach(m => m.classList.add("hidden")); };

    // 画像URL三段フォールバック
    const buildDriveUrl = (urlOrId) => {
      if (!urlOrId) return null;
      // すでに uc?export=view 形式ならそのまま
      if (urlOrId.includes("/uc?export=view")) return urlOrId;
      // link形式/preview形式 → id抽出
      const m = urlOrId.match(/\/d\/([a-zA-Z0-9_-]{20,})/);
      const id = m ? m[1] : (/^[a-zA-Z0-9_-]{20,}$/.test(urlOrId) ? urlOrId : null);
      return id ? `https://drive.google.com/uc?export=view&id=${id}` : urlOrId;
    };
    const setImageWithFallback = (img, primary, proxyKey) => {
      const cands = [];
      if (primary) cands.push(primary);
      const drv = buildDriveUrl(primary);
      if (drv && drv !== primary) cands.push(drv);
      if (proxyKey) cands.push(`${GAS_WEB_APP_URL}?action=image_proxy&key=${encodeURIComponent(proxyKey)}`);
      let i = 0;
      const trySet = () => {
        if (i >= cands.length) return;
        img.src = cands[i++];
      };
      img.onerror = trySet;
      trySet();
    };

    // GAS API
    const callGasApi = async (action, payload = {}) => {
      toggleLoading(true);
      try {
        const req = { action, payload };
        const noAuth = new Set(["login","get_departments","get_supplier_emails","get_item_name","get_item_details"]);
        if (!noAuth.has(action)) {
          if (!state.user) throw new Error("認証情報がありません。再ログインしてください。");
          req.payload.auth = { email: state.user.email };
        }
        const res = await fetch(GAS_WEB_APP_URL, {
          method:"POST",
          headers:{ "Content-Type":"text/plain;charset=utf-8" },
          body: JSON.stringify(req),
          mode:"cors",
        });
        const json = await res.json();
        if (json.status === "error") throw new Error(json.message || "不明なエラー");
        return json;
      } catch (e) {
        alert(`エラー: ${e.message}`);
        return null;
      } finally {
        toggleLoading(false);
      }
    };

    // ====== ログイン ======
    const handleLogin = async ({ loginId, email } = {}) => {
      const r = await callGasApi("login", { loginId, email });
      if (r && r.status === "success") {
        state.user = r.data;
        dom.userName.textContent = state.user.name || "";
        showView("view-home-user");
      } else {
        // フィードバック
        const inp = document.getElementById("login-id-input");
        inp.classList.add("ring-2","ring-red-400");
        setTimeout(() => inp.classList.remove("ring-2","ring-red-400"), 900);
      }
    };

    // ====== 物品一覧 ======
    const renderItemList = () => {
      const container = document.getElementById("item-list-container");
      const q = (document.getElementById("item-search-input").value || "").toLowerCase();
      const onlyReorder = document.getElementById("filter-reorder-needed").checked;
      const onlyOnOrder = document.getElementById("filter-on-order").checked;

      let items = [...state.itemList];
      if (q) items = items.filter(i => (i.itemName || "").toLowerCase().includes(q));
      if (onlyReorder) items = items.filter(i => Number(i.stock) < Number(i.reorderPoint));
      if (onlyOnOrder) items = items.filter(i => Number(i.orderedQuantity) > 0);

      if (!items.length) { container.innerHTML = `<p class="text-center text-gray-500">該当する物品はありません。</p>`; return; }

      container.innerHTML = items.map(it => `
        <div class="item-card p-3 border rounded-lg shadow-sm" data-barcode="${it.barcode||""}" data-qr="${it.qrId||""}">
          <div class="flex items-start justify-between gap-2">
            <div class="min-w-0">
              <h3 class="font-bold text-base leading-tight text-truncate">${it.itemName||""}</h3>
              <p class="text-xs text-gray-500">用途: ${it.useFor||"—"}</p>
            </div>
            <div class="w-16 h-16 overflow-hidden rounded bg-gray-100">
              ${ it.imageUrl
                  ? `<img class="w-full h-full object-cover" src="${buildDriveUrl(it.imageUrl)}" onerror="this.onerror=null;this.src='${GAS_WEB_APP_URL}?action=image_proxy&key=${encodeURIComponent(it.barcode||it.qrId||'')}'">`
                  : `<div class="w-full h-full grid place-items-center text-gray-400 text-xs">No Image</div>` }
            </div>
          </div>

          <div class="display mt-2 text-sm space-y-1">
            <div class="flex justify-between items-center">
              <div class="flex items-center gap-4">
                <div><span class="font-semibold text-gray-600">在庫:</span> <span class="font-bold text-lg">${it.stock ?? ""}</span></div>
                <div><span class="font-semibold text-gray-600">発注点:</span> <span class="text-red-500 font-bold text-lg">${it.reorderPoint ?? ""}</span></div>
              </div>
              <div><span class="font-semibold text-gray-600">単価:</span> ¥${Number(it.price||0).toLocaleString()}</div>
            </div>
            <div class="flex justify-between items-center text-xs text-gray-500 pt-1 border-t">
              <div><span class="font-semibold">発注上限:</span> ${it.parLevel || "未設定"}</div>
              <div><span class="font-semibold">発注中:</span> ${it.orderedQuantity || 0}</div>
            </div>
          </div>

          <div class="mt-3 flex flex-wrap justify-end gap-2">
            <button class="photo-button bg-purple-500 text-white px-3 py-1 rounded-md text-sm">写真</button>
            <button class="inflow-button bg-green-500 text-white px-3 py-1 rounded-md text-sm">入庫</button>
            <button class="outflow-button bg-yellow-500 text-white px-3 py-1 rounded-md text-sm">出庫</button>
          </div>
        </div>
      `).join("");
    };

    const handleShowItemList = async () => {
      const r = await callGasApi("get_item_list", {});
      if (!r) return;
      state.itemList = r.data || [];
      renderItemList();
      showView("view-item-list");
    };

    // ====== 物品一覧：ボタンクリック ======
    document.getElementById("item-list-container").addEventListener("click", (e) => {
      const card = e.target.closest(".item-card"); if (!card) return;
      const barcode = card.dataset.barcode || card.dataset.qr;

      if (e.target.classList.contains("photo-button")) {
        state.photoTarget.barcode = barcode;
        document.getElementById("photo-file-input").click();
      } else if (e.target.classList.contains("inflow-button") || e.target.classList.contains("outflow-button")) {
        startQuickInOut(barcode, e.target.classList.contains("inflow-button") ? "入庫" : "出庫",
                        card.querySelector("h3").textContent);
      }
    });

    // ====== カメラ/写真 → アップロード ======
    const compressToJpegDataUrl = (file, maxW = 1280, quality = 0.85) => new Promise(resolve => {
      const img = new Image();
      const rd = new FileReader();
      rd.onload = () => { img.src = rd.result; };
      img.onload = () => {
        const scale = Math.min(1, maxW / img.width);
        const w = Math.round(img.width * scale);
        const h = Math.round(img.height * scale);
        const cv = document.createElement("canvas"); cv.width = w; cv.height = h;
        const ctx = cv.getContext("2d"); ctx.drawImage(img, 0, 0, w, h);
        resolve(cv.toDataURL("image/jpeg", quality));
      };
      rd.readAsDataURL(file);
    });

    document.getElementById("photo-file-input").addEventListener("change", async (ev) => {
      const f = ev.target.files && ev.target.files[0];
      ev.target.value = "";
      if (!f) return;
      try {
        const dataUrl = await compressToJpegDataUrl(f);
        const r = await callGasApi("upload_item_image", {
          barcode: state.photoTarget.barcode,
          fileName: (state.photoTarget.barcode||"image") + ".jpg",
          imageDataUrl: dataUrl
        });
        if (r && r.status === "success") {
          alert("画像を登録しました。");
          // 再読込して反映
          handleShowItemList();
        }
      } catch (err) {
        alert("アップロードに失敗しました。");
      }
    });

    // ====== 入出庫クイック（数量入力→発注誘導あり） ======
    const startQuickInOut = (code, type, title) => {
      // 数量入力画面を既存UIで
      state.quick = { qrId: code, action: type, itemName: title };
      // ここでは棚卸しUIは使わないので簡易入力
      const qty = prompt(`${title}\n${type}数量を入力してください`, "1");
      if (!qty) return;
      handleStockUpdate(type, code, parseInt(qty,10));
    };

    const handleStockUpdate = async (type, qrId, quantity) => {
      if (!quantity || quantity <= 0) { alert("正しい数量を入力してください。"); return; }
      const r = await callGasApi("stock_update", { type, qrId, quantity });
      if (!r) return;

      if (r.orderRequired) {
        state.orderContext.historyId = r.historyId;
        const { to, subject, body, price } = r.mailPreview;
        state.orderContext.unitPrice = price || 0;
        document.getElementById("preview-to-input").value = to || "";
        document.getElementById("preview-subject-input").value = subject || "";
        document.getElementById("preview-body-input").value = body || "";

        const warn = document.getElementById("outstanding-order-warning");
        if (r.outstandingOrder?.exists) {
          document.getElementById("outstanding-order-message").textContent = `現在 ${r.outstandingOrder.quantity} 個、発注済みです。`;
          warn.classList.remove("hidden");
        } else { warn.classList.add("hidden"); }
        dom.modals.order.classList.remove("hidden");
      } else {
        alert("在庫を更新しました。");
      }
    };

    // ====== 発注メール送信 ======
    const parseQtyFromBody = (t) => { const m = String(t||"").match(/数量[：:\s]*([0-9]+)/); return m ? parseInt(m[1],10) : null; };
    document.getElementById("order-send-button").addEventListener("click", async () => {
      const to = document.getElementById("preview-to-input").value.trim();
      const subject = document.getElementById("preview-subject-input").value.trim();
      const body = document.getElementById("preview-body-input").value.trim();
      if (!to || !subject || !body) { alert("宛先・件名・本文は必須です。"); return; }
      const q = parseQtyFromBody(body); if (!q || q<=0) { alert("本文の『数量』を正しい数値にしてください。"); return; }
      const r = await callGasApi("send_order", { to, subject, body, historyId: state.orderContext.historyId, quantity:q });
      if (r) { hideModals(); alert("発注メールを送信しました。"); }
    });
    document.getElementById("order-discard-button").addEventListener("click", () => { dom.modals.order.classList.add("hidden"); });

    // ====== 発注履歴 ======
    const handleGetOrderHistory = async () => {
      const r = await callGasApi("get_order_history", {});
      if (!r) return;
      const list = document.getElementById("order-history-list");
      if (!r.data.length) list.innerHTML = `<p class="text-center text-gray-500">履歴はありません。</p>`;
      else {
        list.innerHTML = r.data.map(x => `
          <div class="border rounded-md p-3">
            <div class="flex justify-between items-center">
              <div>
                <p class="font-semibold">${x.itemName || "不明な物品"}</p>
                <p class="text-xs text-gray-500">${x.orderDate} / 数量: ${x.quantity} / ステータス: ${x.status}</p>
              </div>
              ${x.status === "注文済み" ? `<button class="cancel-order-button bg-blue-500 text-white px-3 py-1 rounded text-sm" data-mail="${x.mailId}" data-h="${x.historyId}">キャンセル</button>` : ``}
            </div>
          </div>
        `).join("");
      }
      showView("view-order-history");
    };
    document.getElementById("order-history-list").addEventListener("click",(e)=>{
      const btn = e.target.closest(".cancel-order-button"); if(!btn) return;
      confirm("この注文をキャンセルしますか？（キャンセルメール作成画面を開きます）", async ()=>{
        hideModals();
        const r = await callGasApi("cancel_order", { mailId: btn.dataset.mail, historyId: btn.dataset.h });
        if (r) { alert("キャンセルメールを送信しました。"); handleGetOrderHistory(); }
      });
    });

    // ====== 棚卸し ======
    const startInventoryCount = async () => {
      const r = await callGasApi("get_item_list",{});
      if (!r) return;
      state.inventory.items = r.data || [];
      state.inventory.idx = 0;
      showInventoryItem();
      showView("view-inventory-count");
    };

    const showInventoryItem = () => {
      const arr = state.inventory.items; const i = state.inventory.idx;
      if (i >= arr.length) { showDoneAnd("棚卸し完了","全ての物品の確認が終わりました。", goHome); return; }
      document.getElementById("inventory-count-progress").textContent = `${i+1} / ${arr.length}`;
      const item = arr[i];
      document.getElementById("inventory-item-name").textContent = item.itemName || "";
      document.getElementById("inventory-usefor").textContent = item.useFor || "—";

      const img = document.getElementById("inventory-image");
      setImageWithFallback(img, item.imageUrl, item.barcode || item.qrId);
      // Roller初期化
      roller.setValue(Number(item.stock||0));
    };

    const showDoneAnd = (msg, sub, next) => {
      document.getElementById("complete-message").textContent = msg;
      document.getElementById("complete-sub-message").textContent = sub||"";
      showView("view-action-complete");
      setTimeout(next, 1000);
    };

    // Roller 実装
    const rollerEl = document.getElementById("inventory-roller");
    const roller = (() => {
      let val = 0, min=0, max=99999, dragging=false, startY=0, startVal=0;
      const render = () => { rollerEl.textContent = val; rollerEl.setAttribute("aria-valuenow", String(val)); };
      const setValue = (v) => { val = Math.max(min, Math.min(max, Math.round(v))); render(); };
      const step = (d)=> setValue(val + d);
      // wheel
      rollerEl.addEventListener("wheel",(e)=>{ e.preventDefault(); step(e.deltaY>0?-1:1); }, {passive:false});
      // key
      rollerEl.addEventListener("keydown",(e)=>{ if(e.key==="ArrowUp")step(1); else if(e.key==="ArrowDown")step(-1); else if(e.key==="PageUp")step(10); else if(e.key==="PageDown")step(-10); });
      // touch / mouse drag
      const onMove = (y)=>{ const dy = y - startY; const d = Math.round(-dy/28); setValue(startVal + d); };
      rollerEl.addEventListener("pointerdown",(e)=>{ dragging=true; startY=e.clientY; startVal=val; rollerEl.setPointerCapture(e.pointerId); });
      rollerEl.addEventListener("pointermove",(e)=>{ if(dragging) onMove(e.clientY); });
      rollerEl.addEventListener("pointerup",()=>{ dragging=false; });
      document.getElementById("roller-inc").addEventListener("click", ()=> step(1));
      document.getElementById("roller-dec").addEventListener("click", ()=> step(-1));
      return { setValue, get value(){ return val; } };
    })();

    document.getElementById("inventory-confirm-button").addEventListener("click", async ()=>{
      const arr = state.inventory.items; const i = state.inventory.idx; if (i>=arr.length) return;
      const item = arr[i];
      const actual = roller.value;
      const r = await callGasApi("stock_update", { qrId: item.barcode || item.qrId, type:"棚卸修正", quantity: actual, isCorrection:true });
      if (!r) return;
      if (r.orderRequired) {
        state.orderContext.historyId = r.historyId;
        const { to, subject, body, price } = r.mailPreview;
        state.orderContext.unitPrice = price || 0;
        document.getElementById("preview-to-input").value = to || "";
        document.getElementById("preview-subject-input").value = subject || "";
        document.getElementById("preview-body-input").value = body || "";
        document.getElementById("outstanding-order-warning").classList.add("hidden");
        dom.modals.order.classList.remove("hidden");
      } else {
        state.inventory.idx++; showInventoryItem();
      }
    });

    // ====== イベント配線 ======
    const setup = () => {
      // Login
      const loginId = document.getElementById("login-id-input");
      loginId.addEventListener("input",()=>{ if (loginId.value.length === 5) handleLogin({ loginId: loginId.value }); });
      document.getElementById("other-staff-login-button").addEventListener("click", ()=> alert("このビルドでは「その他ログイン」は無効です。"));

      // Header
      dom.mainMenuBtn.addEventListener("click", goHome);
      document.getElementById("logout-button").addEventListener("click", ()=>{ state.user=null; state.historyStack=[]; loginId.value=""; showView("view-login"); });

      // Home menu
      document.getElementById("item-list-button").addEventListener("click", handleShowItemList);
      document.getElementById("inventory-count-button").addEventListener("click", startInventoryCount);
      document.getElementById("order-history-button").addEventListener("click", handleGetOrderHistory);

      // Common back / alert / confirm
      document.querySelectorAll(".back-button").forEach(b=> b.addEventListener("click", goBack));
      document.getElementById("alert-ok-button").addEventListener("click", hideModals);
      document.getElementById("confirm-ok-button").addEventListener("click", ()=>{ dom.modals.confirm.classList.add("hidden"); if (confirmCb) confirmCb(); confirmCb=null; });
      document.getElementById("confirm-cancel-button").addEventListener("click", ()=>{ dom.modals.confirm.classList.add("hidden"); confirmCb=null; });

      // filters
      document.getElementById("item-search-input").addEventListener("input", renderItemList);
      document.getElementById("filter-reorder-needed").addEventListener("change", renderItemList);
      document.getElementById("filter-on-order").addEventListener("change", renderItemList);

      // 初期
      showView("view-login");
    };

    setup();
  })();
  </script>
</body>
</html>
